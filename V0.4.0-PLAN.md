# aiterm v0.4.0 Plan: Workflow Automation & Craft Integration

**Created:** 2025-12-26
**Updated:** 2025-12-27
**Target:** v0.4.0
**Theme:** Workflow automation through aiterm CLI + craft plugin integration

---

## Phase Status

| Phase | Description | Status |
|-------|-------------|--------|
| **Phase 0** | craft v1.5.0 Enhancement | ✅ COMPLETE |
| **Phase 0.5** | craft Mermaid & Worktree Support | ✅ COMPLETE |
| **Phase 1** | Workflow Templates | ⏳ Planned |
| **Phase 1b** | CLI Test Runner | ⏳ Planned |
| **Phase 2** | Craft Plugin Management | ⏳ Planned |
| **Phase 3** | Session-Aware Workflows | ⏳ Planned |
| **Phase 4** | AI Recipe Intelligence | ⏳ Future |

---

## Overview

v0.4.0 bridges the gap between:
- **aiterm CLI** - Terminal setup, context detection, settings management
- **craft plugin** - Claude Code commands, skills, and orchestration (v1.5.0)

**Goal:** Seamless developer workflows from terminal to Claude Code.

---

## Current State

### aiterm v0.3.6 (Current)
- IDE integrations (VS Code, Cursor, Zed, Positron, Windsurf)
- Session coordination (hook-based tracking, conflict detection)
- MCP server management
- Context detection (8 project types)
- curl installer (`install.sh` with auto-detection)
- Dogfooding commands (`hello`, `goodbye`, `info`)
- ~380 tests passing

### craft v1.5.0 ✅ (Prerequisite Complete)

| Metric | v1.2.0 | v1.5.0 | Change |
|--------|--------|--------|--------|
| Commands | 46 | **53** | +7 |
| Agents | 1 | **7** | +6 |
| Skills | 8 | **13** | +5 |

**Added since v1.2.0:**
- 5 documentation agents (docs-architect, tutorial-engineer, api-documenter, reference-builder, mermaid-expert)
- 5 documentation/testing skills (changelog, ADR, OpenAPI, cli-test-strategist, + 1 more)
- 7 new commands: `docs:generate`, `docs:api`, `test:cli-gen`, `test:cli-run`, `dist:homebrew`, `dist:curl-install`, + 1 more

**See:** `PROPOSAL-craft-enhancements-2025-12-26.md` for original specification

---

## v0.4.0 Features

### Phase 0: craft v1.5.0 Enhancement ✅ COMPLETE
**Goal:** Upgrade craft plugin before starting aiterm workflow features

**Status:** ✅ COMPLETE (Dec 27, 2025)

**Delivered:**
1. ✅ Port 5 documentation agents from documentation-generation plugin
2. ✅ Port 5 documentation/testing skills (changelog, ADR, OpenAPI, cli-test, distribution)
3. ✅ Create `docs:generate` command (routes to agents)
4. ✅ Create `docs:api` command (OpenAPI generation)
5. ✅ Create `test:cli-gen` command (CLI test suite generation)
6. ✅ Create `test:cli-run` command (CLI test execution)
7. ✅ Create `dist:homebrew` command (Homebrew formula validation)
8. ✅ Create `dist:curl-install` command (curl installer generation)
9. ✅ Update craft README for v1.5.0
10. ✅ Validate all new components work correctly

**Bonus:** Distribution commands added in v1.5.0 (not in original plan)

### Phase 0.5: craft Mermaid & Worktree Support (Priority: High)
**Goal:** Enhance craft plugin with learnings from Git Worktrees Guide session
**Status:** ✅ COMPLETE (Dec 28, 2025)

**See:** `PROPOSAL-craft-worktree-mermaid-2025-12-28.md` for full specification

#### Quick Wins (~1 hour total) - COMPLETE

| Task | Effort | Status |
|------|--------|--------|
| Add Mermaid config check to `craft:site:status` | 15m | [x] |
| Create Mermaid linter skill | 20m | [x] |
| Update `docs:generate` with Mermaid guidelines | 15m | [x] |
| Add worktree detection to `craft:check` | 20m | [x] |

#### Medium Effort (~2.5 hours) - COMPLETE

| Task | Effort | Status |
|------|--------|--------|
| Create Mermaid diagram templates command | 1h | [x] |
| Implement worktree setup command (`craft:git:worktree`) | 1.5h | [x] |

**Deliverables:**
1. ✅ Mermaid config validation in site:status (prevents "diagrams as code" issue)
2. ✅ Mermaid linter skill for syntax/length validation
3. ✅ Worktree detection for context-aware commands
4. ✅ Mermaid diagram templates (dependency, workflow, architecture, comparison, sequence, state)
5. ✅ Worktree setup automation (stash → checkout → create → pop → install)

**craft v1.8.0 Ready:**
- +1 skill (mermaid-linter) ✅
- +2 commands (git:worktree, docs:mermaid) ✅
- Enhanced: site:status, check, docs:generate ✅

### Phase 1: Workflow Templates (Priority: High)
**Goal:** Pre-configured workflows that chain aiterm + craft commands

```bash
# Example: Full stack development workflow
ait workflow apply fullstack

# Expands to:
# 1. aiterm: Context detection, profile switching
# 2. craft: /craft:check → /craft:test:run → /craft:git:sync
```

**New CLI Module:** `src/aiterm/cli/workflow_recipes.py`

| Command | Description |
|---------|-------------|
| `ait recipes list` | List available workflow recipes |
| `ait recipes show <name>` | Show recipe details |
| `ait recipes apply <name>` | Apply a recipe to current project |
| `ait recipes create` | Interactive recipe builder |
| `ait recipes export` | Export recipe as shareable config |

**Built-in Recipes:**
1. `fullstack` - Full-stack development (test, lint, commit)
2. `release` - Release preparation (/craft:check --for release)
3. `feature` - Feature development flow
4. `debug` - Debugging session setup
5. `docs` - Documentation workflow
6. `r-dev` - R package development (integrates with rforge v0.1.0 tools: `rforge_plan`, `rforge_deps`)

### Phase 1b: CLI Test Runner (Priority: Medium)
**Goal:** Run interactive tests in split terminal from Claude Code

```bash
ait test interactive                    # New window (default)
ait test interactive --split right      # Vertical split
ait test interactive --split below      # Horizontal split
ait test interactive --split tab        # New tab
ait test interactive --terminal ghostty # Force specific terminal
```

**Terminal Support:**
| Terminal | Splits | Tabs | Windows |
|----------|--------|------|---------|
| **Ghostty** (default) | ✅ | ✅ | ✅ |
| **iTerm2** | ✅ | ✅ | ✅ |
| **Terminal.app** | ❌ | ✅ | ✅ |

**Implementation:** `src/aiterm/cli/test_runner.py`
**Prototype:** `scripts/run-interactive-tests.sh` (already implemented)

### Phase 2: Craft Plugin Management (Priority: Medium)
**Goal:** Manage craft plugin from aiterm CLI

```bash
# Install/update craft
ait craft install
ait craft update

# Sync craft with aiterm context
ait craft sync              # Auto-configure based on project type

# Run craft commands from terminal
ait craft run check         # Same as /craft:check in Claude Code
ait craft run test:run release
```

**New CLI Module:** `src/aiterm/cli/craft.py`

| Command | Description |
|---------|-------------|
| `ait craft status` | Show craft plugin status |
| `ait craft install` | Install craft plugin |
| `ait craft update` | Update craft plugin |
| `ait craft sync` | Sync with project context |
| `ait craft run <cmd>` | Execute craft command |
| `ait craft list` | List available craft commands |

### Phase 3: Session-Aware Workflows (Priority: Medium)
**Goal:** Workflows that respect active Claude Code sessions

```bash
# Check if Claude Code is active before running
ait workflow run release --require-session

# Workflows can interact with session task
ait sessions task "Running release workflow"
ait workflow run release
# Task auto-updates as workflow progresses
```

**Integration Points:**
- Hook into `~/.claude/sessions/active/` for session awareness
- Update session task field during workflow execution
- Prevent conflicting workflows on same project

### Phase 4: AI Recipe Intelligence (Priority: Low)
**Goal:** AI-powered recipe suggestions based on project state

```bash
# Suggest next steps based on context
ait recipes suggest

# Output:
# Based on current state:
# - 3 uncommitted changes
# - Tests passing
# - On feature branch
#
# Suggested recipe: 'commit-flow'
# Run: ait recipes apply commit-flow
```

---

## Implementation Timeline

### Week 1-2: Phase 1 (Workflow Templates)
- [ ] Create `workflow_recipes.py` CLI module
- [ ] Define recipe format (YAML/JSON)
- [ ] Implement 6 built-in recipes
- [ ] Add recipe storage in `~/.config/aiterm/recipes/`
- [ ] Write tests (target: 20+ tests)

### Week 3: Phase 2 (Craft Management)
- [ ] Create `craft.py` CLI module
- [ ] Implement install/update/sync commands
- [ ] Add craft command passthrough (`ait craft run`)
- [ ] Write tests (target: 15+ tests)

### Week 4: Phase 3 (Session Integration)
- [ ] Add session checks to workflow runner
- [ ] Implement task auto-update during workflows
- [ ] Add conflict prevention
- [ ] Write tests (target: 10+ tests)

---

## Recipe Format

```yaml
# ~/.config/aiterm/recipes/release.yaml
name: release
description: Release preparation workflow
version: 1.0.0

# Prerequisites
requires:
  - clean_git: true
  - tests_passing: true
  - craft_installed: true

# Steps
steps:
  - name: pre-flight
    type: aiterm
    command: ait sessions prune  # Clean stale sessions

  - name: check
    type: craft
    command: /craft:check --for release

  - name: test
    type: craft
    command: /craft:test:run release

  - name: audit
    type: craft
    command: /craft:code:deps-audit

  - name: changelog
    type: craft
    command: /craft:docs:changelog

# Post-completion
on_success:
  - notify: "Release checks complete"
  - update_task: "Ready for release"
```

---

## Success Criteria

### v0.4.0 MVP
- [ ] 6+ built-in recipes working
- [ ] Recipe list/show/apply commands functional
- [ ] Craft status/install/sync commands working
- [ ] Session-aware workflow execution
- [ ] 45+ new tests
- [ ] Documentation updated

### Quality Metrics
- [ ] 85%+ code coverage on new modules
- [ ] All existing tests passing (~380 tests)
- [ ] No regressions in v0.3.6 features

---

## Files to Create

```
src/aiterm/
├── cli/
│   ├── workflow_recipes.py    # Recipe management
│   └── craft.py               # Craft plugin management
├── recipes/
│   ├── __init__.py
│   ├── loader.py              # Recipe loading/parsing
│   ├── runner.py              # Recipe execution
│   └── templates/             # Built-in recipes
│       ├── fullstack.yaml
│       ├── release.yaml
│       ├── feature.yaml
│       ├── debug.yaml
│       ├── docs.yaml
│       └── r-dev.yaml
tests/
├── test_recipes.py
└── test_craft_integration.py
docs/
├── guide/workflow-recipes.md
└── reference/REFCARD-RECIPES.md
```

---

## Dependencies

- **craft plugin v1.5.0** ✅ - Required for command integration (Phase 0 complete)
- **Session hooks** ✅ - For session-aware workflows (already in v0.3.0)
- **PyYAML** ✅ - For recipe parsing (already a dependency)

---

## Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| craft not installed | Graceful fallback, install prompt |
| Recipe execution fails mid-way | Rollback support, resume capability |
| Version mismatch | Version compatibility checks |

---

## Notes

- Recipes should be project-portable (no absolute paths)
- User recipes override built-in recipes with same name
- Consider marketplace for community recipes in future
